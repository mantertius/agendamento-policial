{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/manoe/OneDrive/Desktop/Programming/agendamento-policial/lib/db.ts"],"sourcesContent":["import Database from 'better-sqlite3';\r\nimport path from 'path';\r\nimport fs from 'fs';\r\n\r\nconst dbPath = path.join(process.cwd(), 'data', 'agendamento.db');\r\n\r\nlet db: Database.Database | null = null;\r\n\r\nfunction getDb(): Database.Database {\r\n  if (db) {\r\n    return db;\r\n  }\r\n\r\n  // Garantir que o diretório existe\r\n  const dataDir = path.dirname(dbPath);\r\n  if (!fs.existsSync(dataDir)) {\r\n    fs.mkdirSync(dataDir, { recursive: true });\r\n  }\r\n\r\n  db = new Database(dbPath);\r\n\r\n  // Habilitar WAL mode para melhor performance\r\n  db.pragma('journal_mode = WAL');\r\n\r\n  // Criar tabelas\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS slots (\r\n      id TEXT PRIMARY KEY,\r\n      date TEXT NOT NULL,\r\n      start_time TEXT NOT NULL,\r\n      end_time TEXT NOT NULL,\r\n      is_booked INTEGER DEFAULT 0,\r\n      is_disabled INTEGER DEFAULT 0\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS bookings (\r\n      id TEXT PRIMARY KEY,\r\n      slot_id TEXT NOT NULL,\r\n      name TEXT NOT NULL,\r\n      phone TEXT,\r\n      email TEXT,\r\n      description TEXT,\r\n      created_at TEXT NOT NULL,\r\n      FOREIGN KEY (slot_id) REFERENCES slots(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS availability_configs (\r\n      id TEXT PRIMARY KEY,\r\n      start_date TEXT NOT NULL,\r\n      end_date TEXT NOT NULL,\r\n      start_time TEXT NOT NULL,\r\n      end_time TEXT NOT NULL,\r\n      slot_duration INTEGER NOT NULL,\r\n      days_of_week TEXT NOT NULL,\r\n      lunch_break_enabled INTEGER DEFAULT 0,\r\n      lunch_break_start TEXT,\r\n      lunch_break_duration INTEGER\r\n    );\r\n\r\n    CREATE INDEX IF NOT EXISTS idx_slots_date ON slots(date);\r\n    CREATE INDEX IF NOT EXISTS idx_bookings_slot_id ON bookings(slot_id);\r\n  `);\r\n\r\n  // Adicionar coluna is_disabled se não existir (migração)\r\n  try {\r\n    db.exec(`ALTER TABLE slots ADD COLUMN is_disabled INTEGER DEFAULT 0`);\r\n  } catch {\r\n    // Coluna já existe\r\n  }\r\n\r\n  // Adicionar colunas de almoço se não existirem (migração)\r\n  try {\r\n    db.exec(`ALTER TABLE availability_configs ADD COLUMN lunch_break_enabled INTEGER DEFAULT 0`);\r\n  } catch {\r\n    // Coluna já existe\r\n  }\r\n  try {\r\n    db.exec(`ALTER TABLE availability_configs ADD COLUMN lunch_break_start TEXT`);\r\n  } catch {\r\n    // Coluna já existe\r\n  }\r\n  try {\r\n    db.exec(`ALTER TABLE availability_configs ADD COLUMN lunch_break_duration INTEGER`);\r\n  } catch {\r\n    // Coluna já existe\r\n  }\r\n\r\n  return db;\r\n}\r\n\r\nexport default getDb;\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,SAAS,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ;AAEhD,IAAI,KAA+B;AAEnC,SAAS;IACP,IAAI,IAAI;QACN,OAAO;IACT;IAEA,kCAAkC;IAClC,MAAM,UAAU,4GAAI,CAAC,OAAO,CAAC;IAC7B,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,UAAU;QAC3B,wGAAE,CAAC,SAAS,CAAC,SAAS;YAAE,WAAW;QAAK;IAC1C;IAEA,KAAK,IAAI,sIAAQ,CAAC;IAElB,6CAA6C;IAC7C,GAAG,MAAM,CAAC;IAEV,gBAAgB;IAChB,GAAG,IAAI,CAAC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAoCT,CAAC;IAED,yDAAyD;IACzD,IAAI;QACF,GAAG,IAAI,CAAC,CAAC,0DAA0D,CAAC;IACtE,EAAE,OAAM;IACN,mBAAmB;IACrB;IAEA,0DAA0D;IAC1D,IAAI;QACF,GAAG,IAAI,CAAC,CAAC,iFAAiF,CAAC;IAC7F,EAAE,OAAM;IACN,mBAAmB;IACrB;IACA,IAAI;QACF,GAAG,IAAI,CAAC,CAAC,kEAAkE,CAAC;IAC9E,EAAE,OAAM;IACN,mBAAmB;IACrB;IACA,IAAI;QACF,GAAG,IAAI,CAAC,CAAC,wEAAwE,CAAC;IACpF,EAAE,OAAM;IACN,mBAAmB;IACrB;IAEA,OAAO;AACT;uCAEe"}},
    {"offset": {"line": 157, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/manoe/OneDrive/Desktop/Programming/agendamento-policial/app/api/slots/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport getDb from '@/lib/db';\r\n\r\ninterface SlotRow {\r\n  id: string;\r\n  date: string;\r\n  start_time: string;\r\n  end_time: string;\r\n  is_booked: number;\r\n}\r\n\r\ninterface BookingRow {\r\n  id: string;\r\n  slot_id: string;\r\n  name: string;\r\n  phone: string | null;\r\n  email: string | null;\r\n  description: string | null;\r\n  created_at: string;\r\n}\r\n\r\nexport async function GET() {\r\n  try {\r\n    const db = getDb();\r\n    const slots = db.prepare('SELECT * FROM slots ORDER BY date, start_time').all() as SlotRow[];\r\n    const bookings = db.prepare('SELECT * FROM bookings').all() as BookingRow[];\r\n\r\n    const formattedSlots = slots.map((slot) => {\r\n      const booking = bookings.find((b) => b.slot_id === slot.id);\r\n      return {\r\n        id: slot.id,\r\n        date: slot.date,\r\n        startTime: slot.start_time,\r\n        endTime: slot.end_time,\r\n        isBooked: slot.is_booked === 1,\r\n        booking: booking ? {\r\n          id: booking.id,\r\n          slotId: booking.slot_id,\r\n          name: booking.name,\r\n          phone: booking.phone || undefined,\r\n          email: booking.email || undefined,\r\n          description: booking.description || undefined,\r\n          createdAt: booking.created_at,\r\n        } : undefined,\r\n      };\r\n    });\r\n\r\n    return NextResponse.json(formattedSlots);\r\n  } catch (error) {\r\n    console.error('Erro ao buscar slots:', error);\r\n    return NextResponse.json({ error: 'Erro ao buscar slots' }, { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const db = getDb();\r\n    const slots = await request.json();\r\n    \r\n    const insertStmt = db.prepare(`\r\n      INSERT OR IGNORE INTO slots (id, date, start_time, end_time, is_booked)\r\n      VALUES (?, ?, ?, ?, ?)\r\n    `);\r\n\r\n    const insertMany = db.transaction((slots: any[]) => {\r\n      for (const slot of slots) {\r\n        insertStmt.run(slot.id, slot.date, slot.startTime, slot.endTime, slot.isBooked ? 1 : 0);\r\n      }\r\n    });\r\n\r\n    insertMany(Array.isArray(slots) ? slots : [slots]);\r\n\r\n    return NextResponse.json({ success: true, count: Array.isArray(slots) ? slots.length : 1 });\r\n  } catch (error) {\r\n    console.error('Erro ao criar slots:', error);\r\n    return NextResponse.json({ error: 'Erro ao criar slots' }, { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function DELETE() {\r\n  try {\r\n    const db = getDb();\r\n    db.prepare('DELETE FROM bookings').run();\r\n    db.prepare('DELETE FROM slots').run();\r\n    return NextResponse.json({ success: true });\r\n  } catch (error) {\r\n    console.error('Erro ao limpar slots:', error);\r\n    return NextResponse.json({ error: 'Erro ao limpar slots' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAoBO,eAAe;IACpB,IAAI;QACF,MAAM,KAAK,IAAA,uLAAK;QAChB,MAAM,QAAQ,GAAG,OAAO,CAAC,iDAAiD,GAAG;QAC7E,MAAM,WAAW,GAAG,OAAO,CAAC,0BAA0B,GAAG;QAEzD,MAAM,iBAAiB,MAAM,GAAG,CAAC,CAAC;YAChC,MAAM,UAAU,SAAS,IAAI,CAAC,CAAC,IAAM,EAAE,OAAO,KAAK,KAAK,EAAE;YAC1D,OAAO;gBACL,IAAI,KAAK,EAAE;gBACX,MAAM,KAAK,IAAI;gBACf,WAAW,KAAK,UAAU;gBAC1B,SAAS,KAAK,QAAQ;gBACtB,UAAU,KAAK,SAAS,KAAK;gBAC7B,SAAS,UAAU;oBACjB,IAAI,QAAQ,EAAE;oBACd,QAAQ,QAAQ,OAAO;oBACvB,MAAM,QAAQ,IAAI;oBAClB,OAAO,QAAQ,KAAK,IAAI;oBACxB,OAAO,QAAQ,KAAK,IAAI;oBACxB,aAAa,QAAQ,WAAW,IAAI;oBACpC,WAAW,QAAQ,UAAU;gBAC/B,IAAI;YACN;QACF;QAEA,OAAO,iNAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,iNAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAuB,GAAG;YAAE,QAAQ;QAAI;IAC5E;AACF;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,KAAK,IAAA,uLAAK;QAChB,MAAM,QAAQ,MAAM,QAAQ,IAAI;QAEhC,MAAM,aAAa,GAAG,OAAO,CAAC,CAAC;;;IAG/B,CAAC;QAED,MAAM,aAAa,GAAG,WAAW,CAAC,CAAC;YACjC,KAAK,MAAM,QAAQ,MAAO;gBACxB,WAAW,GAAG,CAAC,KAAK,EAAE,EAAE,KAAK,IAAI,EAAE,KAAK,SAAS,EAAE,KAAK,OAAO,EAAE,KAAK,QAAQ,GAAG,IAAI;YACvF;QACF;QAEA,WAAW,MAAM,OAAO,CAAC,SAAS,QAAQ;YAAC;SAAM;QAEjD,OAAO,iNAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,OAAO,MAAM,OAAO,CAAC,SAAS,MAAM,MAAM,GAAG;QAAE;IAC3F,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,iNAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAsB,GAAG;YAAE,QAAQ;QAAI;IAC3E;AACF;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,KAAK,IAAA,uLAAK;QAChB,GAAG,OAAO,CAAC,wBAAwB,GAAG;QACtC,GAAG,OAAO,CAAC,qBAAqB,GAAG;QACnC,OAAO,iNAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,iNAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAuB,GAAG;YAAE,QAAQ;QAAI;IAC5E;AACF"}}]
}