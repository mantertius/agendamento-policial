{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/manoe/OneDrive/Desktop/Programming/agendamento-policial/lib/db.ts"],"sourcesContent":["import Database from 'better-sqlite3';\r\nimport path from 'path';\r\nimport fs from 'fs';\r\n\r\nconst dbPath = path.join(process.cwd(), 'data', 'agendamento.db');\r\n\r\nlet db: Database.Database | null = null;\r\n\r\nfunction getDb(): Database.Database {\r\n  if (db) {\r\n    return db;\r\n  }\r\n\r\n  // Garantir que o diretório existe\r\n  const dataDir = path.dirname(dbPath);\r\n  if (!fs.existsSync(dataDir)) {\r\n    fs.mkdirSync(dataDir, { recursive: true });\r\n  }\r\n\r\n  db = new Database(dbPath);\r\n\r\n  // Habilitar WAL mode para melhor performance\r\n  db.pragma('journal_mode = WAL');\r\n\r\n  // Criar tabelas\r\n  db.exec(`\r\n    CREATE TABLE IF NOT EXISTS slots (\r\n      id TEXT PRIMARY KEY,\r\n      date TEXT NOT NULL,\r\n      start_time TEXT NOT NULL,\r\n      end_time TEXT NOT NULL,\r\n      is_booked INTEGER DEFAULT 0,\r\n      is_disabled INTEGER DEFAULT 0\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS bookings (\r\n      id TEXT PRIMARY KEY,\r\n      slot_id TEXT NOT NULL,\r\n      name TEXT NOT NULL,\r\n      cpf TEXT,\r\n      phone TEXT,\r\n      email TEXT,\r\n      description TEXT,\r\n      created_at TEXT NOT NULL,\r\n      FOREIGN KEY (slot_id) REFERENCES slots(id)\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS availability_configs (\r\n      id TEXT PRIMARY KEY,\r\n      start_date TEXT NOT NULL,\r\n      end_date TEXT NOT NULL,\r\n      start_time TEXT NOT NULL,\r\n      end_time TEXT NOT NULL,\r\n      slot_duration INTEGER NOT NULL,\r\n      days_of_week TEXT NOT NULL,\r\n      lunch_break_enabled INTEGER DEFAULT 0,\r\n      lunch_break_start TEXT,\r\n      lunch_break_duration INTEGER\r\n    );\r\n\r\n    CREATE TABLE IF NOT EXISTS counters (\r\n      name TEXT PRIMARY KEY,\r\n      value INTEGER DEFAULT 0\r\n    );\r\n\r\n    CREATE INDEX IF NOT EXISTS idx_slots_date ON slots(date);\r\n    CREATE INDEX IF NOT EXISTS idx_bookings_slot_id ON bookings(slot_id);\r\n  `);\r\n\r\n  // Inicializar contador de agendamentos se não existir\r\n  const counterExists = db.prepare(`SELECT value FROM counters WHERE name = 'booking'`).get();\r\n  if (!counterExists) {\r\n    db.prepare(`INSERT INTO counters (name, value) VALUES ('booking', 0)`).run();\r\n  }\r\n\r\n  // Adicionar coluna is_disabled se não existir (migração)\r\n  try {\r\n    db.exec(`ALTER TABLE slots ADD COLUMN is_disabled INTEGER DEFAULT 0`);\r\n  } catch {\r\n    // Coluna já existe\r\n  }\r\n\r\n  // Adicionar colunas de almoço se não existirem (migração)\r\n  try {\r\n    db.exec(`ALTER TABLE availability_configs ADD COLUMN lunch_break_enabled INTEGER DEFAULT 0`);\r\n  } catch {\r\n    // Coluna já existe\r\n  }\r\n  try {\r\n    db.exec(`ALTER TABLE availability_configs ADD COLUMN lunch_break_start TEXT`);\r\n  } catch {\r\n    // Coluna já existe\r\n  }\r\n  try {\r\n    db.exec(`ALTER TABLE availability_configs ADD COLUMN lunch_break_duration INTEGER`);\r\n  } catch {\r\n    // Coluna já existe\r\n  }\r\n\r\n  // Adicionar coluna cpf se não existir (migração)\r\n  try {\r\n    db.exec(`ALTER TABLE bookings ADD COLUMN cpf TEXT`);\r\n  } catch {\r\n    // Coluna já existe\r\n  }\r\n\r\n  return db;\r\n}\r\n\r\nexport default getDb;\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,SAAS,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ;AAEhD,IAAI,KAA+B;AAEnC,SAAS;IACP,IAAI,IAAI;QACN,OAAO;IACT;IAEA,kCAAkC;IAClC,MAAM,UAAU,4GAAI,CAAC,OAAO,CAAC;IAC7B,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,UAAU;QAC3B,wGAAE,CAAC,SAAS,CAAC,SAAS;YAAE,WAAW;QAAK;IAC1C;IAEA,KAAK,IAAI,sIAAQ,CAAC;IAElB,6CAA6C;IAC7C,GAAG,MAAM,CAAC;IAEV,gBAAgB;IAChB,GAAG,IAAI,CAAC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA0CT,CAAC;IAED,sDAAsD;IACtD,MAAM,gBAAgB,GAAG,OAAO,CAAC,CAAC,iDAAiD,CAAC,EAAE,GAAG;IACzF,IAAI,CAAC,eAAe;QAClB,GAAG,OAAO,CAAC,CAAC,wDAAwD,CAAC,EAAE,GAAG;IAC5E;IAEA,yDAAyD;IACzD,IAAI;QACF,GAAG,IAAI,CAAC,CAAC,0DAA0D,CAAC;IACtE,EAAE,OAAM;IACN,mBAAmB;IACrB;IAEA,0DAA0D;IAC1D,IAAI;QACF,GAAG,IAAI,CAAC,CAAC,iFAAiF,CAAC;IAC7F,EAAE,OAAM;IACN,mBAAmB;IACrB;IACA,IAAI;QACF,GAAG,IAAI,CAAC,CAAC,kEAAkE,CAAC;IAC9E,EAAE,OAAM;IACN,mBAAmB;IACrB;IACA,IAAI;QACF,GAAG,IAAI,CAAC,CAAC,wEAAwE,CAAC;IACpF,EAAE,OAAM;IACN,mBAAmB;IACrB;IAEA,iDAAiD;IACjD,IAAI;QACF,GAAG,IAAI,CAAC,CAAC,wCAAwC,CAAC;IACpD,EAAE,OAAM;IACN,mBAAmB;IACrB;IAEA,OAAO;AACT;uCAEe"}},
    {"offset": {"line": 174, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/manoe/OneDrive/Desktop/Programming/agendamento-policial/app/api/bookings/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport getDb from '@/lib/db';\r\n\r\nexport async function GET() {\r\n  try {\r\n    const db = getDb();\r\n    const bookings = db.prepare('SELECT * FROM bookings ORDER BY created_at DESC').all();\r\n\r\n    const formattedBookings = bookings.map((b: any) => ({\r\n      id: b.id,\r\n      slotId: b.slot_id,\r\n      name: b.name,\r\n      cpf: b.cpf || undefined,\r\n      phone: b.phone || undefined,\r\n      email: b.email || undefined,\r\n      description: b.description || undefined,\r\n      createdAt: b.created_at,\r\n    }));\r\n\r\n    return NextResponse.json(formattedBookings);\r\n  } catch (error) {\r\n    console.error('Erro ao buscar agendamentos:', error);\r\n    return NextResponse.json({ error: 'Erro ao buscar agendamentos' }, { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const db = getDb();\r\n    const booking = await request.json();\r\n\r\n    // Verificar se o slot existe e não está reservado\r\n    const slot = db.prepare('SELECT * FROM slots WHERE id = ?').get(booking.slotId) as any;\r\n    \r\n    if (!slot) {\r\n      return NextResponse.json({ error: 'Slot não encontrado' }, { status: 404 });\r\n    }\r\n\r\n    if (slot.is_booked === 1) {\r\n      return NextResponse.json({ error: 'Slot já está reservado' }, { status: 400 });\r\n    }\r\n\r\n    // Gerar ID sequencial no formato AG-0001\r\n    const counter = db.prepare('SELECT value FROM counters WHERE name = ?').get('booking') as any;\r\n    const nextValue = (counter?.value || 0) + 1;\r\n    db.prepare('UPDATE counters SET value = ? WHERE name = ?').run(nextValue, 'booking');\r\n    const bookingId = `AG-${String(nextValue).padStart(4, '0')}`;\r\n\r\n    // Inserir agendamento\r\n    db.prepare(`\r\n      INSERT INTO bookings (id, slot_id, name, cpf, phone, email, description, created_at)\r\n      VALUES (?, ?, ?, ?, ?, ?, ?, ?)\r\n    `).run(\r\n      bookingId,\r\n      booking.slotId,\r\n      booking.name,\r\n      booking.cpf || null,\r\n      booking.phone || null,\r\n      booking.email || null,\r\n      booking.description || null,\r\n      booking.createdAt\r\n    );\r\n\r\n    // Atualizar slot como reservado\r\n    db.prepare('UPDATE slots SET is_booked = 1 WHERE id = ?').run(booking.slotId);\r\n\r\n    return NextResponse.json({ success: true, booking: { ...booking, id: bookingId } });\r\n  } catch (error) {\r\n    console.error('Erro ao criar agendamento:', error);\r\n    return NextResponse.json({ error: 'Erro ao criar agendamento' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,KAAK,IAAA,uLAAK;QAChB,MAAM,WAAW,GAAG,OAAO,CAAC,mDAAmD,GAAG;QAElF,MAAM,oBAAoB,SAAS,GAAG,CAAC,CAAC,IAAW,CAAC;gBAClD,IAAI,EAAE,EAAE;gBACR,QAAQ,EAAE,OAAO;gBACjB,MAAM,EAAE,IAAI;gBACZ,KAAK,EAAE,GAAG,IAAI;gBACd,OAAO,EAAE,KAAK,IAAI;gBAClB,OAAO,EAAE,KAAK,IAAI;gBAClB,aAAa,EAAE,WAAW,IAAI;gBAC9B,WAAW,EAAE,UAAU;YACzB,CAAC;QAED,OAAO,iNAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO,iNAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA8B,GAAG;YAAE,QAAQ;QAAI;IACnF;AACF;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,KAAK,IAAA,uLAAK;QAChB,MAAM,UAAU,MAAM,QAAQ,IAAI;QAElC,kDAAkD;QAClD,MAAM,OAAO,GAAG,OAAO,CAAC,oCAAoC,GAAG,CAAC,QAAQ,MAAM;QAE9E,IAAI,CAAC,MAAM;YACT,OAAO,iNAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC3E;QAEA,IAAI,KAAK,SAAS,KAAK,GAAG;YACxB,OAAO,iNAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAyB,GAAG;gBAAE,QAAQ;YAAI;QAC9E;QAEA,yCAAyC;QACzC,MAAM,UAAU,GAAG,OAAO,CAAC,6CAA6C,GAAG,CAAC;QAC5E,MAAM,YAAY,CAAC,SAAS,SAAS,CAAC,IAAI;QAC1C,GAAG,OAAO,CAAC,gDAAgD,GAAG,CAAC,WAAW;QAC1E,MAAM,YAAY,CAAC,GAAG,EAAE,OAAO,WAAW,QAAQ,CAAC,GAAG,MAAM;QAE5D,sBAAsB;QACtB,GAAG,OAAO,CAAC,CAAC;;;IAGZ,CAAC,EAAE,GAAG,CACJ,WACA,QAAQ,MAAM,EACd,QAAQ,IAAI,EACZ,QAAQ,GAAG,IAAI,MACf,QAAQ,KAAK,IAAI,MACjB,QAAQ,KAAK,IAAI,MACjB,QAAQ,WAAW,IAAI,MACvB,QAAQ,SAAS;QAGnB,gCAAgC;QAChC,GAAG,OAAO,CAAC,+CAA+C,GAAG,CAAC,QAAQ,MAAM;QAE5E,OAAO,iNAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,SAAS;gBAAE,GAAG,OAAO;gBAAE,IAAI;YAAU;QAAE;IACnF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO,iNAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA4B,GAAG;YAAE,QAAQ;QAAI;IACjF;AACF"}}]
}